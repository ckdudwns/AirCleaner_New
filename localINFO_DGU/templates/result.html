<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ê¸°ì§ˆ ê²€ìƒ‰ ê²°ê³¼</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 20px; max-width: 800px; margin-left: auto; margin-right: auto; line-height: 1.6; }
        a { color: #007bff; text-decoration: none; }
        .card { border: 1px solid #e1e4e8; border-radius: 6px; padding: 16px; margin-bottom: 20px; }
        .card h2 { margin-top: 0; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
        table { width: 100%; border-collapse: collapse; margin-top: 16px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f7f7ff; }
        .actions { display: flex; gap: 8px; margin-top: 16px; align-items: center; }
        .btn { display: inline-block; text-align: center; padding: 10px 16px; font-size: 14px; cursor: pointer; border: 1px solid #6c757d; background-color: #6c757d; color: white; border-radius: 4px; }
        .btn:disabled { background-color: #aaa; border-color: #aaa; cursor: not-allowed; }
        input[type="number"] { padding: 8px; font-size: 14px; width: 70px; border: 1px solid #ccc; border-radius: 4px; text-align: center;}
    </style>
</head>
<body>
    <h1>"{{ raw_query }}" ê²€ìƒ‰ ê²°ê³¼</h1>
    <p><a href="/"> &laquo; ë‹¤ë¥¸ ì¥ì†Œ ê²€ìƒ‰í•˜ê¸°</a></p>

    <div class="card">
        <h2>ğŸ“ ê²€ìƒ‰ ìœ„ì¹˜ ì •ë³´</h2>
        <ul>
            <li><strong>ê²€ìƒ‰ì–´ ìœ í˜•:</strong> {{ search_type }}</li>
            {% if place_name %}<li><strong>ì¥ì†Œëª…:</strong> {{ place_name }}</li>{% endif %}
            {% if address %}<li><strong>ì£¼ì†Œ:</strong> {{ address }}</li>{% endif %}
            <li><strong>ì¢Œí‘œ:</strong> ìœ„ë„ {{ "%.6f"|format(lat) }}, ê²½ë„ {{ "%.6f"|format(lon) }}</li>
        </ul>
        
        <div class="actions">
            <label for="monthsInput">ìµœê·¼</label>
            <input type="number" id="monthsInput" value="12" min="1" max="60">
            <label for="monthsInput">ê°œì›” ë°ì´í„°</label>
            <button id="previewBtn" class="btn">ë¯¸ë¦¬ë³´ê¸°</button>
        </div>
        <small style="color: #666; margin-top: 8px; display: block;">ìµœì‹  1ë…„ì€ API, ê·¸ ì´ì „ì€ CSV íŒŒì¼ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ì•„ë˜ì— í‘œë¡œ í‘œì‹œí•©ë‹ˆë‹¤.</small>
    </div>
    
    <div class="card" id="downloadResultCard" style="display: none;">
        <h2>ğŸ“Š ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</h2>
        <div id="downloadedDataTable"></div>
    </div>

    <!-- (ê¸°ì¡´ ì‹¤ì‹œê°„, ì›”ë³„, ì—°ë„ë³„, ê³¼ê±° ë°ì´í„° í‘œì‹œëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€) -->
    <div class="card">
        <h2>ğŸ’¨ ì‹¤ì‹œê°„ ëŒ€ê¸°ì§ˆ ì •ë³´ (ì¸ê·¼ ì¸¡ì •ì†Œ)</h2>
        {% if average_pm10 is not none %}
            <p><strong>ì¸ê·¼ ì¸¡ì •ì†Œ í‰ê·  PM10:</strong> {{ "%.1f"|format(average_pm10) }} Âµg/mÂ³</p>
        {% endif %}
        {% if average_pm25 is not none %}
            <p><strong>ì¸ê·¼ ì¸¡ì •ì†Œ í‰ê·  PM2.5:</strong> {{ "%.1f"|format(average_pm25) }} Âµg/mÂ³</p>
        {% endif %}
        
        <div class="grid">
            {% for item in realtime %}
            <div class="card">
                <strong>{{ item.stationName }}</strong> ({{ item.distance }}km)<br>
                <small>{{ item.addr }}</small><br>
                <small>ì¸¡ì •ë§: {{ item.network_type or 'ì •ë³´ì—†ìŒ' }}</small>
                <hr>
                PM10: <strong>{{ item.pm10_ug_m3 or '-' }}</strong> Âµg/mÂ³ ({{ item.pm10_category or 'N/A' }})<br>
                PM2.5: <strong>{{ item.pm2_5_ug_m3 or '-' }}</strong> Âµg/mÂ³ ({{ item.pm2_5_category or 'N/A' }})<br>
                <small>ì¸¡ì •ì‹œê°: {{ item.timestamp or '-' }}</small>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="card">
        <h2>ğŸ—“ï¸ ì›”ë³„ í‰ê·  ë†ë„ ({{ month_range.begin }} ~ {{ month_range.end }})</h2>
        <table>
            <thead>
                <tr>
                    <th>ì¸¡ì •ì†Œëª…</th>
                    <th>ì¸¡ì •ì›”</th>
                    <th>PM10 (Âµg/mÂ³)</th>
                    <th>PM2.5 (Âµg/mÂ³)</th>
                </tr>
            </thead>
            <tbody>
                {% for item in monthly %}
                <tr>
                    <td>{{ item.stationName }}</td>
                    <td>{{ item.month }}</td>
                    <td>{{ item.pm10_avg or '-' }}</td>
                    <td>{{ item.pm25_avg or '-' }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if annual %}
    <div class="card">
        <h2>ğŸ“… ì—°ë„ë³„ í‰ê·  ë†ë„</h2>
        <table>
            <thead>
                <tr>
                    <th>ì¸¡ì •ì†Œëª…</th>
                    <th>ì¸¡ì •ì—°ë„</th>
                    <th>PM10 (Âµg/mÂ³)</th>
                    <th>PM2.5 (Âµg/mÂ³)</th>
                </tr>
            </thead>
            <tbody>
                {% for item in annual %}
                <tr>
                    <td>{{ item.stationName }}</td>
                    <td>{{ item.year }}</td>
                    <td>{{ "%.2f"|format(item.pm10_avg) if item.pm10_avg is not none else '-' }}</td>
                    <td>{{ "%.2f"|format(item.pm25_avg) if item.pm25_avg is not none else '-' }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if past_annual_data %}
    <div class="card">
        <h2>ğŸ“œ ê³¼ê±° ì—°ë„ë³„ í‰ê·  ë†ë„ ë¹„êµ (2020ë…„ ~ í˜„ì¬)</h2>
        <p><small>ì‚¬ìš©ìê°€ ì œê³µí•œ CSV íŒŒì¼ ê¸°ë°˜ì˜ ë°ì´í„°ì…ë‹ˆë‹¤.</small></p>
        <table>
            <thead>
                <tr>
                    <th>ì¸¡ì •ì†Œëª…</th>
                    <th>ì—°ë„</th>
                    <th>ì—°í‰ê·  PM10 (Âµg/mÂ³)</th>
                    <th>ì—°í‰ê·  PM2.5 (Âµg/mÂ³)</th>
                </tr>
            </thead>
            <tbody>
                {% for item in past_annual_data %}
                <tr>
                    <td>{{ item.ì¸¡ì •ì†Œëª… }}</td>
                    <td>{{ item.ì—°ë„ }}</td>
                    <td>{{ "%.2f"|format(item.annual_pm10_avg) if item.annual_pm10_avg is not none else '-' }}</td>
                    <td>{{ "%.2f"|format(item.annual_pm25_avg) if item.annual_pm25_avg is not none else '-' }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4">ê³¼ê±° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <script>
        var previewedJsonData = []; // ë¯¸ë¦¬ë³´ê¸°ë¡œ ê°€ì ¸ì˜¨ JSON ë°ì´í„°ë¥¼ ì €ì¥í•  ë³€ìˆ˜

        // 'ë¯¸ë¦¬ë³´ê¸°' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('previewBtn').addEventListener('click', async function() {
            var btn = this;
            var months = document.getElementById('monthsInput').value;
            if (!months || parseInt(months, 10) < 1) {
                alert('1 ì´ìƒì˜ ê°œì›” ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'ì²˜ë¦¬ ì¤‘...';

            var rawQuery = {{ raw_query|tojson }};
            var url = '/api/combined-monthly-data?months=' + months + '&q=' + encodeURIComponent(rawQuery);

            try {
                var response = await fetch(url);
                var data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ì„œë²„ ì˜¤ë¥˜');
                }
                
                previewedJsonData = data; // ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ ë³€ìˆ˜ì— ì €ì¥
                displayJsonAsTable(data, 'downloadedDataTable');

            } catch (error) {
                console.error('ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                alert('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ë¯¸ë¦¬ë³´ê¸°';
            }
        });

        // JSON ë°ì´í„°ë¥¼ CSV ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function convertJsonToCsv(jsonData) {
            if (!jsonData || jsonData.length === 0) {
                return '';
            }
            var headers = Object.keys(jsonData[0]);
            var csvRows = [headers.join(',')]; // í—¤ë” ì¶”ê°€

            jsonData.forEach(function(row) {
                var values = headers.map(function(header) {
                    return row[header];
                });
                csvRows.push(values.join(','));
            });

            return csvRows.join('\n');
        }

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜
        function triggerFileDownload(csvContent, fileName) {
            var blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement("a");
            var url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // JSON ë°ì´í„°ë¥¼ HTML í…Œì´ë¸”ë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function displayJsonAsTable(jsonData, containerId) {
            var container = document.getElementById(containerId);
            var resultCard = document.getElementById('downloadResultCard');
            if (!container || !resultCard) return;

            if (!jsonData || jsonData.length === 0) {
                container.innerHTML = '<p>í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                resultCard.style.display = 'block';
                return;
            }

            var headers = Object.keys(jsonData[0]);
            var tableHtml = '<table><thead><tr>';
            headers.forEach(function(header) {
                tableHtml += '<th>' + header + '</th>';
            });
            tableHtml += '</tr></thead><tbody>';

            jsonData.forEach(function(row) {
                tableHtml += '<tr>';
                headers.forEach(function(header) {
                    var cellValue = row[header] !== null && row[header] !== undefined ? row[header] : '-';
                    tableHtml += '<td>' + cellValue + '</td>';
                });
                tableHtml += '</tr>';
            });
            tableHtml += '</tbody></table>';

            var downloadButtonHtml = '<button id="exportBtn" class="btn" style="margin-top: 10px;">ì´ í‘œë¥¼ CSVë¡œ ë‹¤ìš´ë¡œë“œ</button>';
            container.innerHTML = tableHtml + downloadButtonHtml;

            document.getElementById('exportBtn').addEventListener('click', function() {
                var months = document.getElementById('monthsInput').value;
                var filename = 'ì›”ë³„í‰ê· _ìµœê·¼_' + months + '_ê°œì›”.csv';
                var csvContent = convertJsonToCsv(previewedJsonData);
                triggerFileDownload(csvContent, filename);
            });

            resultCard.style.display = 'block';
        }
    </script>

</body>
</html>
